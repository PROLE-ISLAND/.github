# =====================================================
# Dependabot PR è‡ªå‹•ãƒãƒ¼ã‚¸
# minor/patchæ›´æ–°ã§CIé€šéæ™‚ã«è‡ªå‹•ãƒãƒ¼ã‚¸
# =====================================================
#
# ä½¿ç”¨æ–¹æ³•:
# 1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/dependabot-auto-merge.yml ã«ã‚³ãƒ”ãƒ¼
# 2. ãƒªãƒã‚¸ãƒˆãƒªã§å‹•ä½œç¢ºèª
#
# å‚è€ƒ: docs/DEPENDABOT_POLICY.md

name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot-auto-merge:
    name: Auto-Merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Dependabot ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: è‡ªå‹•ãƒãƒ¼ã‚¸æ¡ä»¶åˆ¤å®š
        id: check
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          DEP_TYPE="${{ steps.metadata.outputs.dependency-type }}"

          echo "Update type: $UPDATE_TYPE"
          echo "Dependency type: $DEP_TYPE"

          # ãƒãƒ¼ã‚¸å¯èƒ½æ¡ä»¶:
          # 1. minor ã¾ãŸã¯ patch æ›´æ–°
          # 2. é–‹ç™ºä¾å­˜ ã¾ãŸã¯ æœ¬ç•ªä¾å­˜ã®minor/patch

          if [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] || \
             [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=Minor/Patchæ›´æ–°ã®ãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸å¯¾è±¡" >> $GITHUB_OUTPUT
          else
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            echo "reason=Majoræ›´æ–°ã®ãŸã‚æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦" >> $GITHUB_OUTPUT
          fi

      - name: CIå®Œäº†å¾…æ©Ÿ
        if: steps.check.outputs.auto_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request.head.sha;

            // æœ€å¤§10åˆ†å¾…æ©Ÿ
            const maxAttempts = 20;
            const interval = 30000; // 30ç§’

            for (let i = 0; i < maxAttempts; i++) {
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha,
              });

              const ciCheck = checkRuns.check_runs.find(
                run => run.name === 'CI' || run.name.includes('build')
              );

              if (ciCheck && ciCheck.status === 'completed') {
                if (ciCheck.conclusion === 'success') {
                  console.log('CI passed, proceeding with auto-merge');
                  return;
                } else {
                  core.setFailed(`CI failed with conclusion: ${ciCheck.conclusion}`);
                  return;
                }
              }

              console.log(`Waiting for CI... (attempt ${i + 1}/${maxAttempts})`);
              await new Promise(r => setTimeout(r, interval));
            }

            core.setFailed('CI did not complete within timeout');

      - name: è‡ªå‹•æ‰¿èª
        if: steps.check.outputs.auto_merge == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆsquashï¼‰
        if: steps.check.outputs.auto_merge == 'true'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Majoræ›´æ–°é€šçŸ¥
        if: steps.check.outputs.auto_merge == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const updateType = '${{ steps.metadata.outputs.update-type }}';
            const depName = '${{ steps.metadata.outputs.dependency-names }}';
            const prevVersion = '${{ steps.metadata.outputs.previous-version }}';
            const newVersion = '${{ steps.metadata.outputs.new-version }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Majoræ›´æ–°æ¤œå‡º

**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: \`${depName}\`
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: \`${prevVersion}\` â†’ \`${newVersion}\`
**æ›´æ–°ã‚¿ã‚¤ãƒ—**: ${updateType}

ã“ã®æ›´æ–°ã¯ **major version** ã®å¤‰æ›´ã‚’å«ã‚€ãŸã‚ã€æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] CHANGELOG / Breaking Changes ã‚’ç¢ºèª
- [ ] äº’æ›æ€§ã¸ã®å½±éŸ¿ã‚’è©•ä¾¡
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ä¿®æ­£

### å¯¾å¿œã‚³ãƒãƒ³ãƒ‰
\`\`\`bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª
npm install ${depName}@${newVersion}
npm run lint && npm run type-check && npm run test:run

# å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸
gh pr merge ${context.issue.number} --squash
\`\`\`

ğŸ“š [Dependaboté‹ç”¨ãƒãƒªã‚·ãƒ¼](https://github.com/PROLE-ISLAND/.github/blob/main/docs/DEPENDABOT_POLICY.md)`
            });
