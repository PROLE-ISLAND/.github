# èª¿æŸ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# è¦ä»¶å®šç¾©ã‚’å«ã‚€PRã§é–¢é€£Issueã« investigation-complete ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆã«ãƒ–ãƒ­ãƒƒã‚¯
#
# ä½¿ç”¨æ–¹æ³•: å„ãƒªãƒã‚¸ãƒˆãƒªã® .github/workflows/ ã«ã‚³ãƒ”ãƒ¼

name: Investigation Governance

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-investigation:
    name: èª¿æŸ»å®Œäº†ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write

    steps:
      - name: PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å¤‰æ›´ç¨®åˆ¥ã‚’åˆ¤å®š
        id: check-type
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # èª¿æŸ»ä¸è¦ãªå¤‰æ›´ç¨®åˆ¥
          if [[ "$PR_TITLE" =~ ^(fix|docs|style|refactor|test|chore|ci|deps|perf): ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=å¤‰æ›´ç¨®åˆ¥ãŒèª¿æŸ»ä¸è¦ï¼ˆ$PR_TITLEï¼‰" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" =~ ^feat: ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "reason=æ–°æ©Ÿèƒ½ï¼ˆfeatï¼‰ã¯èª¿æŸ»å¿…é ˆ" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "reason=å¤‰æ›´ç¨®åˆ¥ä¸æ˜ã€èª¿æŸ»ãƒã‚§ãƒƒã‚¯å®Ÿæ–½" >> $GITHUB_OUTPUT
          fi

      - name: é–¢é€£Issueã‚’æŠ½å‡º
        if: steps.check-type.outputs.skip == 'false'
        id: extract-issue
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # closes #123, fixes #456, resolves #789 ãªã©ã‚’æŠ½å‡º
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '(closes|fixes|resolves)\s*#[0-9]+' | grep -oE '[0-9]+' | head -1)

          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "issue_number=$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
            echo "has_issue=true" >> $GITHUB_OUTPUT
          fi

      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        uses: actions/checkout@v4

      - name: è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        id: check-requirements-change
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")

          # docs/requirements/ é…ä¸‹ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if echo "$CHANGED_FILES" | grep -q "^docs/requirements/"; then
            echo "has_requirements_change=true" >> $GITHUB_OUTPUT
            echo "requirements_message=âš ï¸ è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º" >> $GITHUB_OUTPUT
          else
            echo "has_requirements_change=false" >> $GITHUB_OUTPUT
            echo "requirements_message=è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—" >> $GITHUB_OUTPUT
          fi

      - name: Issueãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        id: check-labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          REPO="${{ github.repository }}"

          # Issueã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
          LABELS=$(gh api repos/$REPO/issues/$ISSUE_NUMBER --jq '.labels[].name' 2>/dev/null || echo "")

          echo "Issue #$ISSUE_NUMBER ã®ãƒ©ãƒ™ãƒ«: $LABELS"

          # investigation-complete ãƒã‚§ãƒƒã‚¯
          if echo "$LABELS" | grep -q "investigation-complete"; then
            echo "investigation_complete=true" >> $GITHUB_OUTPUT
            echo "investigation_message=âœ… èª¿æŸ»å®Œäº†æ¸ˆã¿ï¼ˆinvestigation-complete ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "needs-investigation"; then
            echo "investigation_complete=false" >> $GITHUB_OUTPUT
            echo "investigation_message=âŒ èª¿æŸ»æœªå®Œäº†ï¼ˆneeds-investigation ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "no-investigation"; then
            echo "investigation_complete=true" >> $GITHUB_OUTPUT
            echo "investigation_message=âœ… èª¿æŸ»ä¸è¦ï¼ˆno-investigation ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          else
            echo "investigation_complete=false" >> $GITHUB_OUTPUT
            echo "investigation_message=âš ï¸ èª¿æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ˜ï¼ˆãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ï¼‰" >> $GITHUB_OUTPUT
          fi

      - name: èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆã®å­˜åœ¨ã‚’ç¢ºèª
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        id: check-report
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          REPO="${{ github.repository }}"

          # Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆã‚’æ¤œç´¢
          COMMENTS=$(gh api repos/$REPO/issues/$ISSUE_NUMBER/comments --jq '.[].body' 2>/dev/null || echo "")

          if echo "$COMMENTS" | grep -q "Investigation Report v1"; then
            echo "has_report=true" >> $GITHUB_OUTPUT
            echo "report_message=âœ… èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆï¼ˆInvestigation Report v1ï¼‰ãŒå­˜åœ¨" >> $GITHUB_OUTPUT
          else
            echo "has_report=false" >> $GITHUB_OUTPUT
            echo "report_message=âš ï¸ èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_OUTPUT
          fi

      - name: çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.check-type.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
          if [ "${{ steps.extract-issue.outputs.has_issue }}" == "false" ]; then
            COMMENT="## ğŸ”¬ èª¿æŸ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ

          âŒ **é–¢é€£IssueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“**

          PRæœ¬æ–‡ã« \`closes #ç•ªå·\` å½¢å¼ã§Issueã‚’ç´ä»˜ã‘ã¦ãã ã•ã„ã€‚

          **å‚ç…§**: [èª¿æŸ»ã‚¹ã‚­ãƒ«æ´»ç”¨ã‚¬ã‚¤ãƒ‰](https://github.com/PROLE-ISLAND/.github/wiki/èª¿æŸ»ã‚¹ã‚­ãƒ«æ´»ç”¨ã‚¬ã‚¤ãƒ‰)"
          else
            ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
            INVESTIGATION_MESSAGE="${{ steps.check-labels.outputs.investigation_message }}"
            REPORT_MESSAGE="${{ steps.check-report.outputs.report_message }}"
            REQUIREMENTS_MESSAGE="${{ steps.check-requirements-change.outputs.requirements_message }}"

            COMMENT="## ğŸ”¬ èª¿æŸ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ

          **é–¢é€£Issue**: #$ISSUE_NUMBER

          ### ãƒã‚§ãƒƒã‚¯é …ç›®

          | é …ç›® | çµæœ |
          |------|------|
          | èª¿æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | $INVESTIGATION_MESSAGE |
          | èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ | $REPORT_MESSAGE |
          | è¦ä»¶å®šç¾©å¤‰æ›´ | $REQUIREMENTS_MESSAGE |

          **å‚ç…§**:
          - [èª¿æŸ»ã‚¹ã‚­ãƒ«æ´»ç”¨ã‚¬ã‚¤ãƒ‰](https://github.com/PROLE-ISLAND/.github/wiki/èª¿æŸ»ã‚¹ã‚­ãƒ«æ´»ç”¨ã‚¬ã‚¤ãƒ‰)
          - [/investigate ã‚¹ã‚­ãƒ«](https://github.com/PROLE-ISLAND/.github/blob/main/skill-templates/investigate.md)
          - [è¦ä»¶å®šç¾©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/PROLE-ISLAND/.github/wiki/è¦ä»¶å®šç¾©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)"
          fi

          # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã¦æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
          EXISTING_COMMENT=$(gh api repos/$REPO/issues/$PR_NUMBER/comments --jq '.[] | select(.body | startswith("## ğŸ”¬ èª¿æŸ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            gh api repos/$REPO/issues/comments/$EXISTING_COMMENT -X PATCH -f body="$COMMENT"
          else
            gh api repos/$REPO/issues/$PR_NUMBER/comments -f body="$COMMENT"
          fi

      - name: èª¿æŸ»æœªå®Œäº†ã®å ´åˆã«å¤±æ•—
        if: steps.check-type.outputs.skip == 'false'
        run: |
          FAILED=false

          if [ "${{ steps.extract-issue.outputs.has_issue }}" == "false" ]; then
            echo "âŒ é–¢é€£IssueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "PRæœ¬æ–‡ã« 'closes #ç•ªå·' å½¢å¼ã§Issueã‚’ç´ä»˜ã‘ã¦ãã ã•ã„"
            exit 1
          fi

          # èª¿æŸ»å®Œäº†ãƒã‚§ãƒƒã‚¯ï¼ˆfeat PRã®å ´åˆã®ã¿å¼·åˆ¶ï¼‰
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" =~ ^feat: ]]; then
            if [ "${{ steps.check-labels.outputs.investigation_complete }}" != "true" ]; then
              echo "âŒ èª¿æŸ»ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
              echo "${{ steps.check-labels.outputs.investigation_message }}"
              echo ""
              echo "ã€èª¿æŸ»ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆåŸå‰‡ã€‘"
              echo "1. /investigate ã‚³ãƒãƒ³ãƒ‰ã§æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’èª¿æŸ»"
              echo "2. Investigation Report v1 ã‚’ Issue ã‚³ãƒ¡ãƒ³ãƒˆã«æŠ•ç¨¿"
              echo "3. investigation-complete ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸"
              echo "4. è¦ä»¶å®šç¾©ã‚’é–‹å§‹"
              FAILED=true
            fi
          fi

          # è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã¯èª¿æŸ»å®Œäº†å¿…é ˆ
          if [ "${{ steps.check-requirements-change.outputs.has_requirements_change }}" == "true" ]; then
            if [ "${{ steps.check-labels.outputs.investigation_complete }}" != "true" ]; then
              echo "âŒ è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹PRã«ã¯èª¿æŸ»å®Œäº†ãŒå¿…é ˆã§ã™"
              FAILED=true
            fi
          fi

          if [ "$FAILED" == "true" ]; then
            echo ""
            echo "ã€èª¿æŸ»â†’è¦ä»¶å®šç¾©ãƒ•ãƒ­ãƒ¼ã€‘"
            echo "Step 1: /investigate ã§æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ èª¿æŸ»"
            echo "Step 2: Investigation Report v1 ã‚’ä½œæˆ"
            echo "Step 3: investigation-complete ãƒ©ãƒ™ãƒ«ä»˜ä¸"
            echo "Step 4: è¦ä»¶å®šç¾©é–‹å§‹"
            exit 1
          fi

          echo "âœ… èª¿æŸ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯é€šé"

      - name: ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if: steps.check-type.outputs.skip == 'true'
        run: |
          echo "â„¹ï¸ èª¿æŸ»ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          echo "${{ steps.check-type.outputs.reason }}"
