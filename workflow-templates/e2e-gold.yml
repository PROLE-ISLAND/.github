# =====================================================
# Gold E2Eãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# äº‹æ¥­ç¶™ç¶šã«å¿…é ˆã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
# ãƒˆãƒªã‚¬ãƒ¼: dod:goldãƒ©ãƒ™ãƒ«PRã€mainã¸ã®push
# =====================================================

name: Gold E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: e2e-gold-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==================================================
  # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
  # ==================================================
  check-env:
    name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      env_ready: ${{ steps.check.outputs.env_ready }}
      missing_vars: ${{ steps.check.outputs.missing_vars }}
    steps:
      - id: check
        name: å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        run: |
          missing=""
          env_ready="true"

          # å¿…é ˆç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ç·¨é›†ï¼‰
          # ==================================================
          # E2E_TEST_EMAIL: ãƒ†ã‚¹ãƒˆç”¨ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«
          if [ -z "${{ secrets.E2E_TEST_EMAIL }}" ]; then
            missing="${missing}E2E_TEST_EMAIL, "
            env_ready="false"
          fi

          # E2E_TEST_PASSWORD: ãƒ†ã‚¹ãƒˆç”¨ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          if [ -z "${{ secrets.E2E_TEST_PASSWORD }}" ]; then
            missing="${missing}E2E_TEST_PASSWORD, "
            env_ready="false"
          fi
          # ==================================================

          # çµæžœã‚’å‡ºåŠ›
          if [ "$env_ready" = "false" ]; then
            echo "::error::âŒ å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š: ${missing%%, }"
            echo "::error::ðŸ“– è¨­å®šæ–¹æ³•: https://github.com/PROLE-ISLAND/.github/wiki/Goldå®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
          fi

          echo "env_ready=$env_ready" >> $GITHUB_OUTPUT
          echo "missing_vars=${missing%%, }" >> $GITHUB_OUTPUT

  # ==================================================
  # å®Ÿè¡Œåˆ¤å®š
  # ==================================================
  should-run:
    name: å®Ÿè¡Œåˆ¤å®š
    needs: check-env
    runs-on: ubuntu-latest
    outputs:
      run_gold: ${{ steps.check.outputs.run_gold }}
    steps:
      - id: check
        run: |
          # ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ "${{ needs.check-env.outputs.env_ready }}" != "true" ]]; then
            echo "::warning::Gold E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—: ç’°å¢ƒå¤‰æ•°æœªè¨­å®š"
            echo "run_gold=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¯å¸¸ã«å®Ÿè¡Œ
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "run_gold=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PRã®å ´åˆã€dod:goldãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'
            if echo "$labels" | grep -q "dod:gold"; then
              echo "run_gold=true" >> $GITHUB_OUTPUT
            else
              echo "run_gold=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # workflow_dispatchã¯å¸¸ã«å®Ÿè¡Œ
          echo "run_gold=true" >> $GITHUB_OUTPUT

  # ==================================================
  # Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ==================================================
  gold-e2e:
    name: Gold E2E (${{ matrix.spec }})
    needs: [check-env, should-run]
    if: needs.should-run.outputs.run_gold == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        spec:
          # Goldä»•æ§˜ã«åˆã‚ã›ã¦ç·¨é›†
          - GS-001-example
          # - GS-002-example
          # - GS-003-example
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ - ${{ matrix.spec }}
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          # è¿½åŠ ã®ç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã«è¨­å®š
        run: |
          echo "ðŸ¥‡ Running Gold E2E: ${{ matrix.spec }}"
          npx playwright test e2e/gold/${{ matrix.spec }}.spec.ts --reporter=list

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gold-e2e-failure-${{ matrix.spec }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ==================================================
  # ç’°å¢ƒå¤‰æ•°æœªè¨­å®šæ™‚ã®è­¦å‘ŠPRé€šçŸ¥
  # ==================================================
  notify-env-missing:
    name: ç’°å¢ƒå¤‰æ•°æœªè¨­å®šé€šçŸ¥
    needs: check-env
    if: needs.check-env.outputs.env_ready != 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            const missing = '${{ needs.check-env.outputs.missing_vars }}';
            const body = `## âš ï¸ Gold E2Eãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ

            **ç†ç”±**: å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š

            ### æœªè¨­å®šã®å¤‰æ•°
            \`\`\`
            ${missing}
            \`\`\`

            ### å¯¾å¿œæ–¹æ³•
            1. [Goldå®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](https://github.com/PROLE-ISLAND/.github/wiki/Goldå®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ) ã‚’ç¢ºèª
            2. GitHub Secrets ã«å¿…è¦ãªå¤‰æ•°ã‚’è¨­å®š
            3. ã“ã®PRã‚’å†å®Ÿè¡Œ

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ==================================================
  # çµæžœã‚µãƒžãƒªãƒ¼
  # ==================================================
  gold-summary:
    name: Gold E2Eã‚µãƒžãƒªãƒ¼
    needs: [should-run, gold-e2e]
    if: always() && needs.should-run.outputs.run_gold == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
        run: |
          echo "## ðŸ¥‡ Gold E2Eãƒ†ã‚¹ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gold-e2e.result }}" == "success" ]]; then
            echo "âœ… **å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚ã‚Š**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

  # ==================================================
  # ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ã‚µãƒžãƒªãƒ¼
  # ==================================================
  gold-skip:
    name: Gold E2Eã‚¹ã‚­ãƒƒãƒ—
    needs: should-run
    if: needs.should-run.outputs.run_gold != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ã‚¹ã‚­ãƒƒãƒ—ç†ç”±å‡ºåŠ›
        run: |
          echo "## â­ï¸ Gold E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç†ç”±**: dod:goldãƒ©ãƒ™ãƒ«ãŒãªã„ã‹ã€ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Gold E2Eã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯:" >> $GITHUB_STEP_SUMMARY
          echo "1. PRã« \`dod:gold\` ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸Ž" >> $GITHUB_STEP_SUMMARY
          echo "2. å¿…è¦ãªç’°å¢ƒå¤‰æ•°ï¼ˆSecretsï¼‰ã‚’è¨­å®š" >> $GITHUB_STEP_SUMMARY
