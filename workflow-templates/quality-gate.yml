# =====================================================
# Quality Gateï¼ˆçµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
# DoD Level ã«å¿œã˜ãŸå“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
# Bronze: ã‚«ãƒãƒ¬ãƒƒã‚¸80%ã€Silver: +ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€Gold: +E2E
# =====================================================

name: ğŸ¯ Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      dod_level:
        description: 'DoD Level to check'
        required: true
        default: 'bronze'
        type: choice
        options:
          - bronze
          - silver
          - gold

env:
  # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ï¼ˆDoDæº–æ‹ ï¼‰
  COVERAGE_BRONZE: 80
  COVERAGE_SILVER: 85
  COVERAGE_GOLD: 95

jobs:
  # ===========================================
  # Bronze Gate - PRæœ€ä½åŸºæº–ï¼ˆ27è¦³ç‚¹ï¼‰
  # ===========================================
  bronze-gate:
    name: ğŸ¥‰ Bronze Gate
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # A1: å‹å®‰å…¨æ€§
      - name: ğŸ”· A1: Type Check
        run: npx tsc --noEmit

      # A2: Linté€šé
      - name: ğŸ”· A2: Lint Check
        run: npm run lint

      # B1-B9: ãƒ†ã‚¹ãƒˆé–¢é€£
      - name: ğŸ§ª B1-B9: Unit Tests with Coverage
        run: npm run test:coverage

      # B2: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
      - name: ğŸ“Š B2: Coverage Threshold Check (â‰§80%)
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_BRONZE }}" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below Bronze threshold (${{ env.COVERAGE_BRONZE }}%)"
              exit 1
            fi
            echo "âœ… Coverage meets Bronze threshold"
          else
            echo "::warning::Coverage report not found. Skipping threshold check."
          fi

      # K1: ãƒ“ãƒ«ãƒ‰é€šé
      - name: ğŸ—ï¸ K1: Build Check
        run: npm run build

      - name: ğŸ“ Bronze Gate Summary
        if: always()
        run: |
          echo "## ğŸ¥‰ Bronze Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| A1: Type Check | ${{ steps.type-check.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| A2: Lint | ${{ steps.lint.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| B1-B9: Tests | ${{ steps.tests.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| K1: Build | ${{ steps.build.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Silver Gate - ãƒãƒ¼ã‚¸å¯èƒ½åŸºæº–ï¼ˆ+31è¦³ç‚¹ï¼‰
  # ===========================================
  silver-gate:
    name: ğŸ¥ˆ Silver Gate
    runs-on: ubuntu-latest
    needs: bronze-gate
    # PRãƒ©ãƒ™ãƒ«ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã§Silverä»¥ä¸ŠãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      contains(github.event.pull_request.labels.*.name, 'dod:silver') ||
      contains(github.event.pull_request.labels.*.name, 'dod:gold') ||
      github.event.inputs.dod_level == 'silver' ||
      github.event.inputs.dod_level == 'gold'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # C10: ä¾å­˜è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      - name: ğŸ”’ C10: Security Audit
        run: npm audit --audit-level=high
        continue-on-error: true

      # F8: çµ±åˆãƒ†ã‚¹ãƒˆ
      - name: ğŸ”— F8: Integration Tests
        run: npm run test:integration || echo "::warning::Integration tests not configured"
        continue-on-error: true

      # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆSilver: 85%ï¼‰
      - name: ğŸ“Š Coverage Threshold Check (â‰§85%)
        run: |
          npm run test:coverage
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_SILVER }}" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below Silver threshold (${{ env.COVERAGE_SILVER }}%)"
              exit 1
            fi
            echo "âœ… Coverage meets Silver threshold"
          fi

      - name: ğŸ“ Silver Gate Summary
        if: always()
        run: |
          echo "## ğŸ¥ˆ Silver Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| C10: Security Audit | âœ… (warnings allowed) |" >> $GITHUB_STEP_SUMMARY
          echo "| F8: Integration Tests | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage â‰§85% | âœ… |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Gold Gate - æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹åŸºæº–ï¼ˆ+19è¦³ç‚¹ï¼‰
  # ===========================================
  gold-gate:
    name: ğŸ¥‡ Gold Gate
    runs-on: ubuntu-latest
    needs: silver-gate
    # PRãƒ©ãƒ™ãƒ«ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã§GoldãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      contains(github.event.pull_request.labels.*.name, 'dod:gold') ||
      github.event.inputs.dod_level == 'gold'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # B10: E2Eãƒ†ã‚¹ãƒˆ
      - name: ğŸ­ B10: E2E Tests
        run: |
          npx playwright install --with-deps
          npm run test:e2e || echo "::warning::E2E tests not configured"
        continue-on-error: true

      # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆGold: 95%ï¼‰
      - name: ğŸ“Š Coverage Threshold Check (â‰§95%)
        run: |
          npm run test:coverage
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_GOLD }}" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below Gold threshold (${{ env.COVERAGE_GOLD }}%)"
              exit 1
            fi
            echo "âœ… Coverage meets Gold threshold"
          fi

      # D1-D7: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆLighthouseï¼‰
      - name: ğŸš€ D1-D7: Performance Check
        run: |
          echo "::notice::Performance tests should be run separately with lighthouse-ci"
          # npx lhci autorun || true

      - name: ğŸ“ Gold Gate Summary
        if: always()
        run: |
          echo "## ğŸ¥‡ Gold Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| B10: E2E Tests | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage â‰§95% | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| D1-D7: Performance | âš ï¸ (manual) |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Final Status Comment
  # ===========================================
  status-comment:
    name: ğŸ“‹ Status Comment
    runs-on: ubuntu-latest
    needs: [bronze-gate, silver-gate, gold-gate]
    if: always()

    steps:
      - name: ğŸ“ Post Status Comment
        uses: actions/github-script@v7
        with:
          script: |
            const bronzeResult = '${{ needs.bronze-gate.result }}';
            const silverResult = '${{ needs.silver-gate.result }}';
            const goldResult = '${{ needs.gold-gate.result }}';

            let level = 'Bronze';
            let emoji = 'ğŸ¥‰';
            let status = bronzeResult === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';

            if (silverResult === 'success') {
              level = 'Silver';
              emoji = 'ğŸ¥ˆ';
            }
            if (goldResult === 'success') {
              level = 'Gold';
              emoji = 'ğŸ¥‡';
            }

            const comment = `## ${emoji} Quality Gate: ${level} ${status}

            | Gate | Result |
            |------|--------|
            | ğŸ¥‰ Bronze | ${bronzeResult === 'success' ? 'âœ…' : bronzeResult === 'skipped' ? 'â­ï¸' : 'âŒ'} |
            | ğŸ¥ˆ Silver | ${silverResult === 'success' ? 'âœ…' : silverResult === 'skipped' ? 'â­ï¸' : 'âŒ'} |
            | ğŸ¥‡ Gold | ${goldResult === 'success' ? 'âœ…' : goldResult === 'skipped' ? 'â­ï¸' : 'âŒ'} |

            > è©³ç´°ã¯ [DoD_STANDARDS.md](https://github.com/PROLE-ISLAND/.github/blob/main/DoD_STANDARDS.md) ã‚’å‚ç…§
            `;

            // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Quality Gate:')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
