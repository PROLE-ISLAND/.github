# =====================================================
# Reusable Label Protection
# 組織全体で使用可能な再利用可能ワークフロー
# =====================================================

name: Reusable Label Protection

on:
  workflow_call:
    inputs:
      language:
        description: 'Primary language for messages (ja/en)'
        required: false
        default: 'ja'
        type: string
      protected_labels:
        description: 'Labels that cannot be removed (comma-separated)'
        required: false
        default: 'needs-triage,blocked,security,P0,needs-template-fix'
        type: string
      warn_labels:
        description: 'Labels that trigger warnings when removed (comma-separated)'
        required: false
        default: 'design-review,ready-to-develop,in-progress'
        type: string
      authorized_users:
        description: 'Users who can remove protected labels (comma-separated)'
        required: false
        default: ''
        type: string

jobs:
  protect-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Protect Critical Labels
        uses: actions/github-script@v7
        with:
          script: |
            const removedLabel = context.payload.label.name;
            const removedBy = context.payload.sender.login;
            const isIssue = !!context.payload.issue;
            const itemNumber = isIssue
              ? context.payload.issue.number
              : context.payload.pull_request.number;
            const lang = '${{ inputs.language }}';

            const protectedLabels = '${{ inputs.protected_labels }}'.split(',').map(s => s.trim()).filter(s => s);
            const warnLabels = '${{ inputs.warn_labels }}'.split(',').map(s => s.trim()).filter(s => s);
            const authorizedUsers = '${{ inputs.authorized_users }}'.split(',').map(s => s.trim()).filter(s => s);

            // Skip for bots
            if (removedBy.includes('[bot]')) {
              console.log('Label removed by bot, skipping');
              return;
            }

            const isAuthorized = authorizedUsers.includes(removedBy);

            if (protectedLabels.includes(removedLabel) && !isAuthorized) {
              // Re-add the protected label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: itemNumber,
                labels: [removedLabel]
              });

              const comment = lang === 'ja' ? `## ⚠️ ラベル保護

\`${removedLabel}\` ラベルは保護されているため、削除できません。

**保護されたラベル一覧:**
| ラベル | 理由 |
|--------|------|
| \`needs-triage\` | トリアージ完了まで削除不可 |
| \`blocked\` | ブロック解除まで削除不可 |
| \`security\` | セキュリティ対応完了まで削除不可 |
| \`P0\` | クリティカル優先度は維持必須 |
| \`needs-template-fix\` | テンプレート修正完了まで削除不可 |

ラベルを削除する必要がある場合は、メンテナーに連絡してください。

---
*削除を試みたユーザー: @${removedBy}*` : `## ⚠️ Label Protection

The \`${removedLabel}\` label is protected and cannot be removed.

**Protected Labels:**
| Label | Reason |
|-------|--------|
| \`needs-triage\` | Cannot remove until triage is complete |
| \`blocked\` | Cannot remove until unblocked |
| \`security\` | Cannot remove until security issue is resolved |
| \`P0\` | Critical priority must be maintained |
| \`needs-template-fix\` | Cannot remove until template is fixed |

Contact a maintainer if you need to remove this label.

---
*Attempted by: @${removedBy}*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: itemNumber,
                body: comment
              });

              console.log(`Protected label "${removedLabel}" was restored`);
            } else if (warnLabels.includes(removedLabel)) {
              console.log(`Warning: "${removedLabel}" was removed by @${removedBy}`);
            } else {
              console.log(`Label "${removedLabel}" removal allowed`);
            }
